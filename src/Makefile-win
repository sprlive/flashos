mbr.bin: mbr.asm
	nasm -I include/ -o out/mbr.bin mbr.asm -l out/mbr.lst
	
loader.bin: loader.asm
	nasm -I include/ -o out/loader.bin loader.asm -l out/loader.lst
	
kernel.bin: kernel/main.c
	gcc -c -o out/main.o kernel/main.c
	ld -Ttext 0xc0001500 out/main.o -o out/kernel.bin
	
os.raw: mbr.bin loader.bin kernel.bin
	qemu-img create -f raw target/os.raw 1440K
	dd if=out/mbr.bin of=target/os.raw bs=512 count=1
	dd if=out/loader.bin of=target/os.raw bs=512 count=4 seek=2
	dd if=out/kernel.bin of=target/os.raw bs=512 count=200 seek=9
	
run:
	make install
	make only-qemu-run
	
brun:
	make install
	make only-bochs-run
	
bdrun:
	make install
	make only-bochsdbg-run
	
only-qemu-run:
	qemu-system-i386 -m 512 target/os.raw
	
only-bochs-run:
	copy /y target\os.raw os.raw
	del ..\Bochs-2.6.11\os.raw.lock /s/q
	bochs.exe -f bochs/bochsrc
	
only-bochsdbg-run:
	copy /y target\os.raw os.raw
	del ..\Bochs-2.6.11\os.raw.lock /s/q
	bochsdbg.exe -f bochs/bochsrc
	
only-run-s:
	qemu-system-i386 -s -S -m 512 target/os.raw --nographic
	
install:
	make clean
	make -r os.raw
	
clean:
	del target /s/q
	del out /s/q
	del os.raw
	del os.raw.lock
	del bochsout.txt